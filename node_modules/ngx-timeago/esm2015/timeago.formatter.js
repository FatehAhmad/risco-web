/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
import { Injectable } from '@angular/core';
import { TimeagoIntl } from './timeago.intl';
import { MINUTE, HOUR, DAY, WEEK, MONTH, YEAR } from './util';
const /** @type {?} */ defaultFormattter = function (then) {
    const /** @type {?} */ now = Date.now();
    const /** @type {?} */ seconds = Math.round(Math.abs(now - then) / 1000);
    const /** @type {?} */ suffix = then < now ? 'ago' : 'from now';
    const [value, unit] = seconds < MINUTE
        ? [Math.round(seconds), 'second']
        : seconds < HOUR
            ? [Math.round(seconds / MINUTE), 'minute']
            : seconds < DAY
                ? [Math.round(seconds / HOUR), 'hour']
                : seconds < WEEK
                    ? [Math.round(seconds / DAY), 'day']
                    : seconds < MONTH
                        ? [Math.round(seconds / WEEK), 'week']
                        : seconds < YEAR
                            ? [Math.round(seconds / MONTH), 'month']
                            : [Math.round(seconds / YEAR), 'year'];
    return { value, unit, suffix };
};
const ɵ0 = defaultFormattter;
/**
 * @abstract
 */
export class TimeagoFormatter {
}
function TimeagoFormatter_tsickle_Closure_declarations() {
    /**
     * @abstract
     * @param {?} then
     * @return {?}
     */
    TimeagoFormatter.prototype.format = function (then) { };
    /**
     * @abstract
     * @param {?} value
     * @param {?} unit
     * @param {?} suffix
     * @param {?=} now
     * @param {?=} then
     * @return {?}
     */
    TimeagoFormatter.prototype.parse = function (value, unit, suffix, now, then) { };
}
export class TimeagoDefaultFormatter extends TimeagoFormatter {
    /**
     * @param {?} then
     * @return {?}
     */
    format(then) {
        const { suffix, value, unit } = defaultFormattter(then);
        return this.parse(value, unit, suffix);
    }
    /**
     * @param {?} value
     * @param {?} unit
     * @param {?} suffix
     * @return {?}
     */
    parse(value, unit, suffix) {
        if (value !== 1) {
            unit += 's';
        }
        return value + ' ' + unit + ' ' + suffix;
    }
}
TimeagoDefaultFormatter.decorators = [
    { type: Injectable },
];
export class TimeagoCustomFormatter extends TimeagoFormatter {
    /**
     * @param {?} intl
     */
    constructor(intl) {
        super();
        this.intl = intl;
    }
    /**
     * @param {?} then
     * @return {?}
     */
    format(then) {
        const { suffix, value, unit } = defaultFormattter(then);
        return this.parse(value, unit, suffix, Date.now(), then);
    }
    /**
     * @param {?} value
     * @param {?} unit
     * @param {?} suffix
     * @param {?} now
     * @param {?} then
     * @return {?}
     */
    parse(value, unit, suffix, now, then) {
        /** convert weeks to days if strings don't handle weeks */
        if (unit === 'week' && !this.intl.strings.week && !this.intl.strings.weeks) {
            const /** @type {?} */ days = Math.round(Math.abs(now - then) / (1000 * 60 * 60 * 24));
            value = days;
            unit = 'day';
        }
        /**
         * create a normalize function for given value
         */
        const /** @type {?} */ normalize = this.normalizeFn(value, now - then, this.intl.strings.numbers);
        /**
         * The eventual return value stored in an array so that the wordSeparator can be used
         */
        const /** @type {?} */ dateString = [];
        /** handle prefixes */
        if (suffix === 'ago' && this.intl.strings.prefixAgo) {
            dateString.push(normalize(this.intl.strings.prefixAgo));
        }
        if (suffix === 'from now' && this.intl.strings.prefixFromNow) {
            dateString.push(normalize(this.intl.strings.prefixFromNow));
        }
        /**
         * Handle Main number and unit
         */
        const /** @type {?} */ isPlural = value > 1;
        if (isPlural) {
            const /** @type {?} */ stringFn = this.intl.strings[unit + 's'] || this.intl.strings[unit] || '%d ' + unit;
            dateString.push(normalize(stringFn));
        }
        else {
            const /** @type {?} */ stringFn = this.intl.strings[unit] || this.intl.strings[unit + 's'] || '%d ' + unit;
            dateString.push(normalize(stringFn));
        }
        /** Handle Suffixes */
        if (suffix === 'ago' && this.intl.strings.suffixAgo) {
            dateString.push(normalize(this.intl.strings.suffixAgo));
        }
        if (suffix === 'from now' && this.intl.strings.suffixFromNow) {
            dateString.push(normalize(this.intl.strings.suffixFromNow));
        }
        /**
         * join the array into a string and return it
         */
        const /** @type {?} */ wordSeparator = typeof this.intl.strings.wordSeparator === 'string' ? this.intl.strings.wordSeparator : ' ';
        return dateString.join(wordSeparator);
    }
    /**
     * If the numbers array is present, format numbers with it,
     * otherwise just cast the number to a string and return it
     * @param {?} numbers
     * @param {?} value
     * @return {?}
     */
    normalizeNumber(numbers, value) {
        return numbers && numbers.length === 10
            ? String(value).split('')
                .map((digit) => digit.match(/^[0-9]$/) ? numbers[parseInt(digit, 10)] : digit)
                .join('')
            : String(value);
    }
    /**
     * Take a string or a function that takes number of days and returns a string
     * and provide a uniform API to create string parts
     * @param {?} value
     * @param {?} millisDelta
     * @param {?=} numbers
     * @return {?}
     */
    normalizeFn(value, millisDelta, numbers) {
        return (stringOrFn) => typeof stringOrFn === 'function'
            ? stringOrFn(value, millisDelta).replace(/%d/g, this.normalizeNumber(numbers, value))
            : stringOrFn.replace(/%d/g, this.normalizeNumber(numbers, value));
    }
}
TimeagoCustomFormatter.decorators = [
    { type: Injectable },
];
/** @nocollapse */
TimeagoCustomFormatter.ctorParameters = () => [
    { type: TimeagoIntl }
];
function TimeagoCustomFormatter_tsickle_Closure_declarations() {
    /** @type {?} */
    TimeagoCustomFormatter.prototype.intl;
}
export { ɵ0 };

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGltZWFnby5mb3JtYXR0ZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZ3gtdGltZWFnby8iLCJzb3VyY2VzIjpbInRpbWVhZ28uZm9ybWF0dGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFZLE1BQU0sZUFBZSxDQUFDO0FBQ3JELE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUM3QyxPQUFPLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsTUFBTSxRQUFRLENBQUM7QUFVOUQsdUJBQU0saUJBQWlCLEdBQUcsVUFBUyxJQUFZO0lBQzdDLHVCQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7SUFDdkIsdUJBQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUM7SUFDeEQsdUJBQU0sTUFBTSxHQUFXLElBQUksR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDO0lBRXZELE1BQU0sQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLEdBQ2pCLE9BQU8sR0FBRyxNQUFNO1FBQ2QsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsRUFBRSxRQUFRLENBQUM7UUFDakMsQ0FBQyxDQUFDLE9BQU8sR0FBRyxJQUFJO1lBQ2QsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLEdBQUcsTUFBTSxDQUFDLEVBQUUsUUFBUSxDQUFDO1lBQzFDLENBQUMsQ0FBQyxPQUFPLEdBQUcsR0FBRztnQkFDYixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsRUFB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QUFDO1lBQ2IsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQzs7Ozs7Ozs7OztJQU9aLFdBQVcsQ0FBQyxLQUFhLEVBQUUsV0FBbUIsRUFBRSxPQUFxQjtRQUMzRSxNQUFNLENBQUMsQ0FBQyxVQUFzQixFQUFFLEVBQUUsQ0FDaEMsT0FBTyxVQUFVLEtBQUssVUFBVTtZQUNoQyxDQUFDLENBQUMsVUFBVSxDQUFDLEtBQUssRUFBRSxXQUFXLENBQUMsQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxlQUFlLENBQUMsT0FBTyxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ3JGLENBQUMsQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsZUFBZSxDQUFDLE9BQU8sRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDOzs7O1lBNUV2RSxVQUFVOzs7O1lBdkRGLFdBQVciLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgVGltZWFnb0ludGwgfSBmcm9tICcuL3RpbWVhZ28uaW50bCc7XG5pbXBvcnQgeyBNSU5VVEUsIEhPVVIsIERBWSwgV0VFSywgTU9OVEgsIFlFQVIgfSBmcm9tICcuL3V0aWwnO1xuXG5leHBvcnQgdHlwZSBVbml0ID0gJ3NlY29uZCcgfCAnbWludXRlJyB8ICdob3VyJyB8ICdkYXknIHwgJ3dlZWsnIHwgJ21vbnRoJyB8ICd5ZWFyJztcblxuZXhwb3J0IHR5cGUgU3VmZml4ID0gJ2FnbycgfCAnZnJvbSBub3cnO1xuXG5leHBvcnQgdHlwZSBTdHJpbmdPckZuID0gKCh2YWx1ZTogbnVtYmVyLCBtaWxsaXNEZWx0YTogIG51bWJlcikgPT4gc3RyaW5nKSB8IHN0cmluZztcblxuZXhwb3J0IHR5cGUgTnVtYmVyQXJyYXkgPSBbIHN0cmluZywgc3RyaW5nLCBzdHJpbmcsIHN0cmluZywgc3RyaW5nLCBzdHJpbmcsIHN0cmluZywgc3RyaW5nLCBzdHJpbmcsIHN0cmluZyBdO1xuXG5jb25zdCBkZWZhdWx0Rm9ybWF0dHRlciA9IGZ1bmN0aW9uKHRoZW46IG51bWJlcik6IHt2YWx1ZTogbnVtYmVyLCB1bml0OiBVbml0LCBzdWZmaXg6IFN1ZmZpeH0ge1xuICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xuICBjb25zdCBzZWNvbmRzID0gTWF0aC5yb3VuZChNYXRoLmFicyhub3cgLSB0aGVuKSAvIDEwMDApO1xuICBjb25zdCBzdWZmaXg6IFN1ZmZpeCA9IHRoZW4gPCBub3cgPyAnYWdvJyA6ICdmcm9tIG5vdyc7XG5cbiAgY29uc3QgW3ZhbHVlLCB1bml0XTogW251bWJlciwgVW5pdF0gPVxuICAgIHNlY29uZHMgPCBNSU5VVEVcbiAgICAgID8gW01hdGgucm91bmQoc2Vjb25kcyksICdzZWNvbmQnXVxuICAgICAgOiBzZWNvbmRzIDwgSE9VUlxuICAgICAgICA/IFtNYXRoLnJvdW5kKHNlY29uZHMgLyBNSU5VVEUpLCAnbWludXRlJ11cbiAgICAgICAgOiBzZWNvbmRzIDwgREFZXG4gICAgICAgICAgPyBbTWF0aC5yb3VuZChzZWNvbmRzIC8gSE9VUiksICdob3VyJ11cbiAgICAgICAgICA6IHNlY29uZHMgPCBXRUVLXG4gICAgICAgICAgICA/IFtNYXRoLnJvdW5kKHNlY29uZHMgLyBEQVkpLCAnZGF5J11cbiAgICAgICAgICAgIDogc2Vjb25kcyA8IE1PTlRIXG4gICAgICAgICAgICAgID8gW01hdGgucm91bmQoc2Vjb25kcyAvIFdFRUspLCAnd2VlayddXG4gICAgICAgICAgICAgIDogc2Vjb25kcyA8IFlFQVJcbiAgICAgICAgICAgICAgICA/IFtNYXRoLnJvdW5kKHNlY29uZHMgLyBNT05USCksICdtb250aCddXG4gICAgICAgICAgICAgICAgOiBbTWF0aC5yb3VuZChzZWNvbmRzIC8gWUVBUiksICd5ZWFyJ107XG5cbiAgcmV0dXJuIHt2YWx1ZSwgdW5pdCwgc3VmZml4fTtcbn1cblxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIFRpbWVhZ29Gb3JtYXR0ZXIge1xuICBhYnN0cmFjdCBmb3JtYXQodGhlbjogbnVtYmVyKTogc3RyaW5nXG5cbiAgcHJvdGVjdGVkIGFic3RyYWN0IHBhcnNlKHZhbHVlOiBudW1iZXIsIHVuaXQ6IFVuaXQsIHN1ZmZpeDogU3VmZml4LCBub3c/OiBudW1iZXIsIHRoZW4/OiBudW1iZXIpOiBzdHJpbmc7XG59XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBUaW1lYWdvRGVmYXVsdEZvcm1hdHRlciBleHRlbmRzIFRpbWVhZ29Gb3JtYXR0ZXIge1xuICBmb3JtYXQodGhlbjogbnVtYmVyKTogc3RyaW5nIHtcbiAgICBjb25zdCB7c3VmZml4LCB2YWx1ZSwgdW5pdH0gPSBkZWZhdWx0Rm9ybWF0dHRlcih0aGVuKTtcbiAgICByZXR1cm4gdGhpcy5wYXJzZSh2YWx1ZSwgdW5pdCwgc3VmZml4KTtcbiAgfVxuXG4gIHByb3RlY3RlZCBwYXJzZSh2YWx1ZTogbnVtYmVyLCB1bml0OiBVbml0LCBzdWZmaXg6IFN1ZmZpeCk6IHN0cmluZyB7XG4gICAgaWYgKHZhbHVlICE9PSAxKSB7XG4gICAgICB1bml0ICs9ICdzJztcbiAgICB9XG4gICAgcmV0dXJuIHZhbHVlICsgJyAnICsgdW5pdCArICcgJyArIHN1ZmZpeDtcbiAgfVxufVxuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgVGltZWFnb0N1c3RvbUZvcm1hdHRlciBleHRlbmRzIFRpbWVhZ29Gb3JtYXR0ZXIge1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGludGw6IFRpbWVhZ29JbnRsKSB7XG4gICAgc3VwZXIoKTtcbiAgfVxuXG4gIGZvcm1hdCh0aGVuOiBudW1iZXIpOiBzdHJpbmcge1xuICAgIGNvbnN0IHtzdWZmaXgsIHZhbHVlLCB1bml0fSA9IGRlZmF1bHRGb3JtYXR0dGVyKHRoZW4pO1xuICAgIHJldHVybiB0aGlzLnBhcnNlKHZhbHVlLCB1bml0LCBzdWZmaXgsIERhdGUubm93KCksIHRoZW4pO1xuICB9XG5cbiAgcHJvdGVjdGVkIHBhcnNlKHZhbHVlOiBudW1iZXIsIHVuaXQ6IFVuaXQsIHN1ZmZpeDogU3VmZml4LCBub3c6IG51bWJlciwgdGhlbjogbnVtYmVyKSB7XG4gICAgLyoqIGNvbnZlcnQgd2Vla3MgdG8gZGF5cyBpZiBzdHJpbmdzIGRvbid0IGhhbmRsZSB3ZWVrcyAqL1xuICAgIGlmICh1bml0ID09PSAnd2VlaycgJiYgIXRoaXMuaW50bC5zdHJpbmdzLndlZWsgJiYgIXRoaXMuaW50bC5zdHJpbmdzLndlZWtzKSB7XG4gICAgICBjb25zdCBkYXlzID0gTWF0aC5yb3VuZChNYXRoLmFicyhub3cgLSB0aGVuKSAvICgxMDAwICogNjAgKiA2MCAqIDI0KSk7XG4gICAgICB2YWx1ZSA9IGRheXM7XG4gICAgICB1bml0ID0gJ2RheSc7XG4gICAgfVxuXG4gICAgLyoqIGNyZWF0ZSBhIG5vcm1hbGl6ZSBmdW5jdGlvbiBmb3IgZ2l2ZW4gdmFsdWUgKi9cbiAgICBjb25zdCBub3JtYWxpemUgPSB0aGlzLm5vcm1hbGl6ZUZuKHZhbHVlLCBub3cgLSB0aGVuLCB0aGlzLmludGwuc3RyaW5ncy5udW1iZXJzKTtcblxuICAgIC8qKiBUaGUgZXZlbnR1YWwgcmV0dXJuIHZhbHVlIHN0b3JlZCBpbiBhbiBhcnJheSBzbyB0aGF0IHRoZSB3b3JkU2VwYXJhdG9yIGNhbiBiZSB1c2VkICovXG4gICAgY29uc3QgZGF0ZVN0cmluZzogc3RyaW5nW10gPSBbXTtcblxuICAgIC8qKiBoYW5kbGUgcHJlZml4ZXMgKi9cbiAgICBpZiAoc3VmZml4ID09PSAnYWdvJyAmJiB0aGlzLmludGwuc3RyaW5ncy5wcmVmaXhBZ28pIHtcbiAgICAgIGRhdGVTdHJpbmcucHVzaChub3JtYWxpemUodGhpcy5pbnRsLnN0cmluZ3MucHJlZml4QWdvKSk7XG4gICAgfVxuICAgIGlmIChzdWZmaXggPT09ICdmcm9tIG5vdycgJiYgdGhpcy5pbnRsLnN0cmluZ3MucHJlZml4RnJvbU5vdykge1xuICAgICAgZGF0ZVN0cmluZy5wdXNoKG5vcm1hbGl6ZSh0aGlzLmludGwuc3RyaW5ncy5wcmVmaXhGcm9tTm93KSk7XG4gICAgfVxuXG4gICAgLyoqIEhhbmRsZSBNYWluIG51bWJlciBhbmQgdW5pdCAqL1xuICAgIGNvbnN0IGlzUGx1cmFsID0gdmFsdWUgPiAxO1xuICAgIGlmIChpc1BsdXJhbCkge1xuICAgICAgY29uc3Qgc3RyaW5nRm46IFN0cmluZ09yRm4gPSB0aGlzLmludGwuc3RyaW5nc1t1bml0ICsgJ3MnXSB8fCB0aGlzLmludGwuc3RyaW5nc1t1bml0XSB8fCAnJWQgJyArIHVuaXQ7XG4gICAgICBkYXRlU3RyaW5nLnB1c2gobm9ybWFsaXplKHN0cmluZ0ZuKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IHN0cmluZ0ZuOiBTdHJpbmdPckZuID0gdGhpcy5pbnRsLnN0cmluZ3NbdW5pdF0gfHwgdGhpcy5pbnRsLnN0cmluZ3NbdW5pdCArICdzJ10gfHwgJyVkICcgKyB1bml0O1xuICAgICAgZGF0ZVN0cmluZy5wdXNoKG5vcm1hbGl6ZShzdHJpbmdGbikpO1xuICAgIH1cblxuICAgIC8qKiBIYW5kbGUgU3VmZml4ZXMgKi9cbiAgICBpZiAoc3VmZml4ID09PSAnYWdvJyAmJiB0aGlzLmludGwuc3RyaW5ncy5zdWZmaXhBZ28pIHtcbiAgICAgIGRhdGVTdHJpbmcucHVzaChub3JtYWxpemUodGhpcy5pbnRsLnN0cmluZ3Muc3VmZml4QWdvKSk7XG4gICAgfVxuICAgIGlmIChzdWZmaXggPT09ICdmcm9tIG5vdycgJiYgdGhpcy5pbnRsLnN0cmluZ3Muc3VmZml4RnJvbU5vdykge1xuICAgICAgZGF0ZVN0cmluZy5wdXNoKG5vcm1hbGl6ZSh0aGlzLmludGwuc3RyaW5ncy5zdWZmaXhGcm9tTm93KSk7XG4gICAgfVxuXG4gICAgLyoqIGpvaW4gdGhlIGFycmF5IGludG8gYSBzdHJpbmcgYW5kIHJldHVybiBpdCAqL1xuICAgIGNvbnN0IHdvcmRTZXBhcmF0b3IgPSB0eXBlb2YgdGhpcy5pbnRsLnN0cmluZ3Mud29yZFNlcGFyYXRvciA9PT0gJ3N0cmluZycgPyB0aGlzLmludGwuc3RyaW5ncy53b3JkU2VwYXJhdG9yIDogJyAnO1xuICAgIHJldHVybiBkYXRlU3RyaW5nLmpvaW4od29yZFNlcGFyYXRvcik7XG4gIH1cblxuICAvKipcbiAgICogSWYgdGhlIG51bWJlcnMgYXJyYXkgaXMgcHJlc2VudCwgZm9ybWF0IG51bWJlcnMgd2l0aCBpdCxcbiAgICogb3RoZXJ3aXNlIGp1c3QgY2FzdCB0aGUgbnVtYmVyIHRvIGEgc3RyaW5nIGFuZCByZXR1cm4gaXRcbiAgKi9cbiAgcHJpdmF0ZSBub3JtYWxpemVOdW1iZXIobnVtYmVyczogTnVtYmVyQXJyYXksIHZhbHVlOiBudW1iZXIpIHtcbiAgICByZXR1cm4gbnVtYmVycyAmJiBudW1iZXJzLmxlbmd0aCA9PT0gMTBcbiAgICAgID8gU3RyaW5nKHZhbHVlKS5zcGxpdCgnJylcbiAgICAgICAgICAubWFwKChkaWdpdDogc3RyaW5nKSA9PiBkaWdpdC5tYXRjaCgvXlswLTldJC8pID8gbnVtYmVyc1twYXJzZUludChkaWdpdCwgMTApXSA6IGRpZ2l0KVxuICAgICAgICAgIC5qb2luKCcnKVxuICAgICAgOiBTdHJpbmcodmFsdWUpO1xuICB9XG5cbiAgLyoqXG4gICAqIFRha2UgYSBzdHJpbmcgb3IgYSBmdW5jdGlvbiB0aGF0IHRha2VzIG51bWJlciBvZiBkYXlzIGFuZCByZXR1cm5zIGEgc3RyaW5nXG4gICAqIGFuZCBwcm92aWRlIGEgdW5pZm9ybSBBUEkgdG8gY3JlYXRlIHN0cmluZyBwYXJ0c1xuICAqL1xuICBwcml2YXRlIG5vcm1hbGl6ZUZuKHZhbHVlOiBudW1iZXIsIG1pbGxpc0RlbHRhOiBudW1iZXIsIG51bWJlcnM/OiBOdW1iZXJBcnJheSkge1xuICAgIHJldHVybiAoc3RyaW5nT3JGbjogU3RyaW5nT3JGbikgPT5cbiAgICAgIHR5cGVvZiBzdHJpbmdPckZuID09PSAnZnVuY3Rpb24nXG4gICAgICA/IHN0cmluZ09yRm4odmFsdWUsIG1pbGxpc0RlbHRhKS5yZXBsYWNlKC8lZC9nLCB0aGlzLm5vcm1hbGl6ZU51bWJlcihudW1iZXJzLCB2YWx1ZSkpXG4gICAgICA6IHN0cmluZ09yRm4ucmVwbGFjZSgvJWQvZywgdGhpcy5ub3JtYWxpemVOdW1iZXIobnVtYmVycywgdmFsdWUpKTtcbiAgfVxufVxuIl19