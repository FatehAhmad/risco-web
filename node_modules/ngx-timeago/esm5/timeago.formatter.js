/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { TimeagoIntl } from './timeago.intl';
import { MINUTE, HOUR, DAY, WEEK, MONTH, YEAR } from './util';
var /** @type {?} */ defaultFormattter = function (then) {
    var /** @type {?} */ now = Date.now();
    var /** @type {?} */ seconds = Math.round(Math.abs(now - then) / 1000);
    var /** @type {?} */ suffix = then < now ? 'ago' : 'from now';
    var _a = tslib_1.__read(seconds < MINUTE
        ? [Math.round(seconds), 'second']
        : seconds < HOUR
            ? [Math.round(seconds / MINUTE), 'minute']
            : seconds < DAY
                ? [Math.round(seconds / HOUR), 'hour']
                : seconds < WEEK
                    ? [Math.round(seconds / DAY), 'day']
                    : seconds < MONTH
                        ? [Math.round(seconds / WEEK), 'week']
                        : seconds < YEAR
                            ? [Math.round(seconds / MONTH), 'month']
                            : [Math.round(seconds / YEAR), 'year'], 2), value = _a[0], unit = _a[1];
    return { value: value, unit: unit, suffix: suffix };
};
var ɵ0 = defaultFormattter;
/**
 * @abstract
 */
var /**
 * @abstract
 */
TimeagoFormatter = /** @class */ (function () {
    function TimeagoFormatter() {
    }
    return TimeagoFormatter;
}());
/**
 * @abstract
 */
export { TimeagoFormatter };
function TimeagoFormatter_tsickle_Closure_declarations() {
    /**
     * @abstract
     * @param {?} then
     * @return {?}
     */
    TimeagoFormatter.prototype.format = function (then) { };
    /**
     * @abstract
     * @param {?} value
     * @param {?} unit
     * @param {?} suffix
     * @param {?=} now
     * @param {?=} then
     * @return {?}
     */
    TimeagoFormatter.prototype.parse = function (value, unit, suffix, now, then) { };
}
var TimeagoDefaultFormatter = /** @class */ (function (_super) {
    tslib_1.__extends(TimeagoDefaultFormatter, _super);
    function TimeagoDefaultFormatter() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    /**
     * @param {?} then
     * @return {?}
     */
    TimeagoDefaultFormatter.prototype.format = /**
     * @param {?} then
     * @return {?}
     */
    function (then) {
        var _a = defaultFormattter(then), suffix = _a.suffix, value = _a.value, unit = _a.unit;
        return this.parse(value, unit, suffix);
    };
    /**
     * @param {?} value
     * @param {?} unit
     * @param {?} suffix
     * @return {?}
     */
    TimeagoDefaultFormatter.prototype.parse = /**
     * @param {?} value
     * @param {?} unit
     * @param {?} suffix
     * @return {?}
     */
    function (value, unit, suffix) {
        if (value !== 1) {
            unit += 's';
        }
        return value + ' ' + unit + ' ' + suffix;
    };
    TimeagoDefaultFormatter.decorators = [
        { type: Injectable },
    ];
    return TimeagoDefaultFormatter;
}(TimeagoFormatter));
export { TimeagoDefaultFormatter };
var TimeagoCustomFormatter = /** @class */ (function (_super) {
    tslib_1.__extends(TimeagoCustomFormatter, _super);
    function TimeagoCustomFormatter(intl) {
        var _this = _super.call(this) || this;
        _this.intl = intl;
        return _this;
    }
    /**
     * @param {?} then
     * @return {?}
     */
    TimeagoCustomFormatter.prototype.format = /**
     * @param {?} then
     * @return {?}
     */
    function (then) {
        var _a = defaultFormattter(then), suffix = _a.suffix, value = _a.value, unit = _a.unit;
        return this.parse(value, unit, suffix, Date.now(), then);
    };
    /**
     * @param {?} value
     * @param {?} unit
     * @param {?} suffix
     * @param {?} now
     * @param {?} then
     * @return {?}
     */
    TimeagoCustomFormatter.prototype.parse = /**
     * @param {?} value
     * @param {?} unit
     * @param {?} suffix
     * @param {?} now
     * @param {?} then
     * @return {?}
     */
    function (value, unit, suffix, now, then) {
        /** convert weeks to days if strings don't handle weeks */
        if (unit === 'week' && !this.intl.strings.week && !this.intl.strings.weeks) {
            var /** @type {?} */ days = Math.round(Math.abs(now - then) / (1000 * 60 * 60 * 24));
            value = days;
            unit = 'day';
        }
        /**
         * create a normalize function for given value
         */
        var /** @type {?} */ normalize = this.normalizeFn(value, now - then, this.intl.strings.numbers);
        /**
         * The eventual return value stored in an array so that the wordSeparator can be used
         */
        var /** @type {?} */ dateString = [];
        /** handle prefixes */
        if (suffix === 'ago' && this.intl.strings.prefixAgo) {
            dateString.push(normalize(this.intl.strings.prefixAgo));
        }
        if (suffix === 'from now' && this.intl.strings.prefixFromNow) {
            dateString.push(normalize(this.intl.strings.prefixFromNow));
        }
        /**
         * Handle Main number and unit
         */
        var /** @type {?} */ isPlural = value > 1;
        if (isPlural) {
            var /** @type {?} */ stringFn = this.intl.strings[unit + 's'] || this.intl.strings[unit] || '%d ' + unit;
            dateString.push(normalize(stringFn));
        }
        else {
            var /** @type {?} */ stringFn = this.intl.strings[unit] || this.intl.strings[unit + 's'] || '%d ' + unit;
            dateString.push(normalize(stringFn));
        }
        /** Handle Suffixes */
        if (suffix === 'ago' && this.intl.strings.suffixAgo) {
            dateString.push(normalize(this.intl.strings.suffixAgo));
        }
        if (suffix === 'from now' && this.intl.strings.suffixFromNow) {
            dateString.push(normalize(this.intl.strings.suffixFromNow));
        }
        /**
         * join the array into a string and return it
         */
        var /** @type {?} */ wordSeparator = typeof this.intl.strings.wordSeparator === 'string' ? this.intl.strings.wordSeparator : ' ';
        return dateString.join(wordSeparator);
    };
    /**
     * If the numbers array is present, format numbers with it,
     * otherwise just cast the number to a string and return it
     * @param {?} numbers
     * @param {?} value
     * @return {?}
     */
    TimeagoCustomFormatter.prototype.normalizeNumber = /**
     * If the numbers array is present, format numbers with it,
     * otherwise just cast the number to a string and return it
     * @param {?} numbers
     * @param {?} value
     * @return {?}
     */
    function (numbers, value) {
        return numbers && numbers.length === 10
            ? String(value).split('')
                .map(function (digit) { return digit.match(/^[0-9]$/) ? numbers[parseInt(digit, 10)] : digit; })
                .join('')
            : String(value);
    };
    /**
     * Take a string or a function that takes number of days and returns a string
     * and provide a uniform API to create string parts
     * @param {?} value
     * @param {?} millisDelta
     * @param {?=} numbers
     * @return {?}
     */
    TimeagoCustomFormatter.prototype.normalizeFn = /**
     * Take a string or a function that takes number of days and returns a string
     * and provide a uniform API to create string parts
     * @param {?} value
     * @param {?} millisDelta
     * @param {?=} numbers
     * @return {?}
     */
    function (value, millisDelta, numbers) {
        var _this = this;
        return function (stringOrFn) {
            return typeof stringOrFn === 'function'
                ? stringOrFn(value, millisDelta).replace(/%d/g, _this.normalizeNumber(numbers, value))
                : stringOrFn.replace(/%d/g, _this.normalizeNumber(numbers, value));
        };
    };
    TimeagoCustomFormatter.decorators = [
        { type: Injectable },
    ];
    /** @nocollapse */
    TimeagoCustomFormatter.ctorParameters = function () { return [
        { type: TimeagoIntl }
    ]; };
    return TimeagoCustomFormatter;
}(TimeagoFormatter));
export { TimeagoCustomFormatter };
function TimeagoCustomFormatter_tsickle_Closure_declarations() {
    /** @type {?} */
    TimeagoCustomFormatter.prototype.intl;
}
export { ɵ0 };

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGltZWFnby5mb3JtYXR0ZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZ3gtdGltZWFnby8iLCJzb3VyY2VzIjpbInRpbWVhZ28uZm9ybWF0dGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBWSxNQUFNLGVBQWUsQ0FBQztBQUNyRCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDN0MsT0FBTyxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLE1BQU0sUUFBUSxDQUFDO0FBVTlELHFCQUFNLGlCQUFpQixHQUFHLFVBQVMsSUFBWTtJQUM3QyxxQkFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO0lBQ3ZCLHFCQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDO0lBQ3hELHFCQUFNLE1BQU0sR0FBVyxJQUFJLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQztJQUV2RDs7Ozs7Ozs7Ozs7O3dFQUFPLGFBQUssRUFBRSxZQUFJLENBYW1DO0lBRXJELE1BQU0sQ0FBQyxFQUFDLEtBQUssT0FBQSxFQUFFLElBQUksTUFBQSxFQUFFLE1BQU0sUUFBQSxFQUFDLENBQUM7Q0FDOUIsQ0FBQTs7Ozs7QUFFRDs7O0FBQUE7OzsyQkFuQ0E7SUF1Q0MsQ0FBQTs7OztBQUpELDRCQUlDOzs7Ozs7Ozs7Ozs7Ozs7Ozs7OztJQUc0QyxtREFBZ0I7Ozs7Ozs7O0lBQzNELHdDQUFNOzs7O0lBQU4sVUFBTyxJQUFZO1FBQ2pCLGtDQUFPLGtCQUFNLEVBQUUsZ0JBQUssRUFBRSxjQUFJLENBQTRCO1FBQ3RELE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxJQUFJLEVBQUUsTUFBTSxDQUFDLENBQUM7S0FDeEM7Ozs7Ozs7SUFFUyx1Q0FBSzs7Ozs7O0lBQWYsVUFBZ0IsS0FBYSxFQUFFLElBQVUsRUFBRSxNQUFjO1FBQ3ZELEVBQUUsQ0FBQyxDQUFDLEtBQUssS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2hCLElBQUksSUFBSSxHQUFHLENBQUM7U0FDYjtRQUNELE1BQU0sQ0FBQyxLQUFLLEdBQUcsR0FBRyxHQUFHLElBQUksR0FBRyxHQUFHLEdBQUcsTUFBTSxDQUFDO0tBQzFDOztnQkFaRixVQUFVOztrQ0F6Q1g7RUEwQzZDLGdCQUFnQjtTQUFoRCx1QkFBdUI7O0lBZVEsa0RBQWdCO0lBQzFELGdDQUFvQixJQUFpQjtRQUFyQyxZQUNFLGlCQUFPLFNBQ1I7UUFGbUIsVUFBSSxHQUFKLElBQUksQ0FBYTs7S0FFcEM7Ozs7O0lBRUQsdUNBQU07Ozs7SUFBTixVQUFPLElBQVk7UUFDakIsa0NBQU8sa0JBQU0sRUFBRSxnQkFBSyxFQUFFLGNBQUksQ0FBNEI7UUFDdEQsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsSUFBSSxDQUFDLEdBQUcsRUFBRSxFQUFFLElBQUksQ0FBQyxDQUFDO0tBQzFEOzs7Ozs7Ozs7SUFFUyxzQ0FBSzs7Ozs7Ozs7SUFBZixVQUFnQixLQUFhLEVBQUUsSUFBVSxFQUFFLE1BQWMsRUFBRSxHQUFXLEVBQUUsSUFBWTs7UUFFbEYsRUFBRSxDQUFDLENBQUMsSUFBSSxLQUFLLE1BQU0sSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7WUFDM0UscUJBQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQ3RFLEtBQUssR0FBRyxJQUFJLENBQUM7WUFDYixJQUFJLEdBQUcsS0FBSyxDQUFDO1NBQ2Q7Ozs7UUFHRCxxQkFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxLQUFLLEVBQUUsR0FBRyxHQUFHLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQzs7OztRQUdqRixxQkFBTSxVQUFVLEdBQWEsRUFBRSxDQUFDOztRQUdoQyxFQUFFLENBQUMsQ0FBQyxNQUFNLEtBQUssS0FBSyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDcEQsVUFBVSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztTQUN6RDtRQUNELEVBQUUsQ0FBQyxDQUFDLE1BQU0sS0FBSyxVQUFVLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQztZQUM3RCxVQUFVLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDO1NBQzdEOzs7O1FBR0QscUJBQU0sUUFBUSxHQUFHLEtBQUssR0FBRyxDQUFDLENBQUM7UUFDM0IsRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztZQUNiLHFCQUFNLFFBQVEsR0FBZSxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEdBQUcsR0FBRyxDQUFDLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQztZQUN0RyxVQUFVLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO1NBQ3RDO1FBQUMsSUFBSSxDQUFDLENBQUM7WUFDTixxQkFBTSxRQUFRLEdBQWUsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxHQUFHLEdBQUcsQ0FBQyxJQUFJLEtBQUssR0FBRyxJQUFJLENBQUM7WUFDdEcsVUFBVSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztTQUN0Qzs7UUFHRCxFQUFFLENBQUMsQ0FBQyxNQUFNLEtBQUssS0FBSyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDcEQsVUFBVSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztTQUN6RDtRQUNELEVBQUUsQ0FBQyxDQUFDLE1BQU0sS0FBSyxVQUFVLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQztZQUM3RCxVQUFVLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDO1NBQzdEOzs7O1FBR0QscUJBQU0sYUFBYSxHQUFHLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsYUFBYSxLQUFLLFFBQVEsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUM7UUFDbEgsTUFBTSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7S0FDdkM7Ozs7Ozs7O0lBTU8sZ0RBQWU7Ozs7Ozs7Y0FBQyxPQUFvQixFQUFFLEtBQWE7UUFDekQsTUFBTSxDQUFDLE9BQU8sSUFBSSxPQUFPLENBQUMsTUFBTSxLQUFLLEVBQUU7WUFDckMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDO2lCQUNwQixHQUFHLENBQUMsVUFBQyxLQUFhLElBQUssT0FBQSxLQUFLLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLEVBQTdELENBQTZELENBQUM7aUJBQ3JGLElBQUksQ0FBQyxFQUFFLENBQUM7WUFDYixDQUFDLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDOzs7Ozs7Ozs7O0lBT1osNENBQVc7Ozs7Ozs7O2NBQUMsS0FBYSxFQUFFLFdBQW1CLEVBQUUsT0FBcUI7O1FBQzNFLE1BQU0sQ0FBQyxVQUFDLFVBQXNCO1lBQzVCLE9BQUEsT0FBTyxVQUFVLEtBQUssVUFBVTtnQkFDaEMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxLQUFLLEVBQUUsV0FBVyxDQUFDLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxLQUFJLENBQUMsZUFBZSxDQUFDLE9BQU8sRUFBRSxLQUFLLENBQUMsQ0FBQztnQkFDckYsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLEtBQUksQ0FBQyxlQUFlLENBQUMsT0FBTyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBRmpFLENBRWlFLENBQUM7OztnQkE1RXZFLFVBQVU7Ozs7Z0JBdkRGLFdBQVc7O2lDQURwQjtFQXlENEMsZ0JBQWdCO1NBQS9DLHNCQUFzQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIE9wdGlvbmFsIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBUaW1lYWdvSW50bCB9IGZyb20gJy4vdGltZWFnby5pbnRsJztcbmltcG9ydCB7IE1JTlVURSwgSE9VUiwgREFZLCBXRUVLLCBNT05USCwgWUVBUiB9IGZyb20gJy4vdXRpbCc7XG5cbmV4cG9ydCB0eXBlIFVuaXQgPSAnc2Vjb25kJyB8ICdtaW51dGUnIHwgJ2hvdXInIHwgJ2RheScgfCAnd2VlaycgfCAnbW9udGgnIHwgJ3llYXInO1xuXG5leHBvcnQgdHlwZSBTdWZmaXggPSAnYWdvJyB8ICdmcm9tIG5vdyc7XG5cbmV4cG9ydCB0eXBlIFN0cmluZ09yRm4gPSAoKHZhbHVlOiBudW1iZXIsIG1pbGxpc0RlbHRhOiAgbnVtYmVyKSA9PiBzdHJpbmcpIHwgc3RyaW5nO1xuXG5leHBvcnQgdHlwZSBOdW1iZXJBcnJheSA9IFsgc3RyaW5nLCBzdHJpbmcsIHN0cmluZywgc3RyaW5nLCBzdHJpbmcsIHN0cmluZywgc3RyaW5nLCBzdHJpbmcsIHN0cmluZywgc3RyaW5nIF07XG5cbmNvbnN0IGRlZmF1bHRGb3JtYXR0dGVyID0gZnVuY3Rpb24odGhlbjogbnVtYmVyKToge3ZhbHVlOiBudW1iZXIsIHVuaXQ6IFVuaXQsIHN1ZmZpeDogU3VmZml4fSB7XG4gIGNvbnN0IG5vdyA9IERhdGUubm93KCk7XG4gIGNvbnN0IHNlY29uZHMgPSBNYXRoLnJvdW5kKE1hdGguYWJzKG5vdyAtIHRoZW4pIC8gMTAwMCk7XG4gIGNvbnN0IHN1ZmZpeDogU3VmZml4ID0gdGhlbiA8IG5vdyA/ICdhZ28nIDogJ2Zyb20gbm93JztcblxuICBjb25zdCBbdmFsdWUsIHVuaXRdOiBbbnVtYmVyLCBVbml0XSA9XG4gICAgc2Vjb25kcyA8IE1JTlVURVxuICAgICAgPyBbTWF0aC5yb3VuZChzZWNvbmRzKSwgJ3NlY29uZCddXG4gICAgICA6IHNlY29uZHMgPCBIT1VSXG4gICAgICAgID8gW01hdGgucm91bmQoc2Vjb25kcyAvIE1JTlVURSksICdtaW51dGUnXVxuICAgICAgICA6IHNlY29uZHMgPCBEQVlcbiAgICAgICAgICA/IFtNYXRoLnJvdW5kKHNlY29uZHMgLyBIT1VSKSwgJ2hvdXInXVxuICAgICAgICAgIDogc2Vjb25kcyA8IFdFRUtcbiAgICAgICAgICAgID8gW01hdGgucm91bmQoc2Vjb25kcyAvIERBWSksICdkYXknXVxuICAgICAgICAgICAgOiBzZWNvbmRzIDwgTU9OVEhcbiAgICAgICAgICAgICAgPyBbTWF0aC5yb3VuZChzZWNvbmRzIC8gV0VFSyksICd3ZWVrJ11cbiAgICAgICAgICAgICAgOiBzZWNvbmRzIDwgWUVBUlxuICAgICAgICAgICAgICAgID8gW01hdGgucm91bmQoc2Vjb25kcyAvIE1PTlRIKSwgJ21vbnRoJ11cbiAgICAgICAgICAgICAgICA6IFtNYXRoLnJvdW5kKHNlY29uZHMgLyBZRUFSKSwgJ3llYXInXTtcblxuICByZXR1cm4ge3ZhbHVlLCB1bml0LCBzdWZmaXh9O1xufVxuXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgVGltZWFnb0Zvcm1hdHRlciB7XG4gIGFic3RyYWN0IGZvcm1hdCh0aGVuOiBudW1iZXIpOiBzdHJpbmdcblxuICBwcm90ZWN0ZWQgYWJzdHJhY3QgcGFyc2UodmFsdWU6IG51bWJlciwgdW5pdDogVW5pdCwgc3VmZml4OiBTdWZmaXgsIG5vdz86IG51bWJlciwgdGhlbj86IG51bWJlcik6IHN0cmluZztcbn1cblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFRpbWVhZ29EZWZhdWx0Rm9ybWF0dGVyIGV4dGVuZHMgVGltZWFnb0Zvcm1hdHRlciB7XG4gIGZvcm1hdCh0aGVuOiBudW1iZXIpOiBzdHJpbmcge1xuICAgIGNvbnN0IHtzdWZmaXgsIHZhbHVlLCB1bml0fSA9IGRlZmF1bHRGb3JtYXR0dGVyKHRoZW4pO1xuICAgIHJldHVybiB0aGlzLnBhcnNlKHZhbHVlLCB1bml0LCBzdWZmaXgpO1xuICB9XG5cbiAgcHJvdGVjdGVkIHBhcnNlKHZhbHVlOiBudW1iZXIsIHVuaXQ6IFVuaXQsIHN1ZmZpeDogU3VmZml4KTogc3RyaW5nIHtcbiAgICBpZiAodmFsdWUgIT09IDEpIHtcbiAgICAgIHVuaXQgKz0gJ3MnO1xuICAgIH1cbiAgICByZXR1cm4gdmFsdWUgKyAnICcgKyB1bml0ICsgJyAnICsgc3VmZml4O1xuICB9XG59XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBUaW1lYWdvQ3VzdG9tRm9ybWF0dGVyIGV4dGVuZHMgVGltZWFnb0Zvcm1hdHRlciB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgaW50bDogVGltZWFnb0ludGwpIHtcbiAgICBzdXBlcigpO1xuICB9XG5cbiAgZm9ybWF0KHRoZW46IG51bWJlcik6IHN0cmluZyB7XG4gICAgY29uc3Qge3N1ZmZpeCwgdmFsdWUsIHVuaXR9ID0gZGVmYXVsdEZvcm1hdHR0ZXIodGhlbik7XG4gICAgcmV0dXJuIHRoaXMucGFyc2UodmFsdWUsIHVuaXQsIHN1ZmZpeCwgRGF0ZS5ub3coKSwgdGhlbik7XG4gIH1cblxuICBwcm90ZWN0ZWQgcGFyc2UodmFsdWU6IG51bWJlciwgdW5pdDogVW5pdCwgc3VmZml4OiBTdWZmaXgsIG5vdzogbnVtYmVyLCB0aGVuOiBudW1iZXIpIHtcbiAgICAvKiogY29udmVydCB3ZWVrcyB0byBkYXlzIGlmIHN0cmluZ3MgZG9uJ3QgaGFuZGxlIHdlZWtzICovXG4gICAgaWYgKHVuaXQgPT09ICd3ZWVrJyAmJiAhdGhpcy5pbnRsLnN0cmluZ3Mud2VlayAmJiAhdGhpcy5pbnRsLnN0cmluZ3Mud2Vla3MpIHtcbiAgICAgIGNvbnN0IGRheXMgPSBNYXRoLnJvdW5kKE1hdGguYWJzKG5vdyAtIHRoZW4pIC8gKDEwMDAgKiA2MCAqIDYwICogMjQpKTtcbiAgICAgIHZhbHVlID0gZGF5cztcbiAgICAgIHVuaXQgPSAnZGF5JztcbiAgICB9XG5cbiAgICAvKiogY3JlYXRlIGEgbm9ybWFsaXplIGZ1bmN0aW9uIGZvciBnaXZlbiB2YWx1ZSAqL1xuICAgIGNvbnN0IG5vcm1hbGl6ZSA9IHRoaXMubm9ybWFsaXplRm4odmFsdWUsIG5vdyAtIHRoZW4sIHRoaXMuaW50bC5zdHJpbmdzLm51bWJlcnMpO1xuXG4gICAgLyoqIFRoZSBldmVudHVhbCByZXR1cm4gdmFsdWUgc3RvcmVkIGluIGFuIGFycmF5IHNvIHRoYXQgdGhlIHdvcmRTZXBhcmF0b3IgY2FuIGJlIHVzZWQgKi9cbiAgICBjb25zdCBkYXRlU3RyaW5nOiBzdHJpbmdbXSA9IFtdO1xuXG4gICAgLyoqIGhhbmRsZSBwcmVmaXhlcyAqL1xuICAgIGlmIChzdWZmaXggPT09ICdhZ28nICYmIHRoaXMuaW50bC5zdHJpbmdzLnByZWZpeEFnbykge1xuICAgICAgZGF0ZVN0cmluZy5wdXNoKG5vcm1hbGl6ZSh0aGlzLmludGwuc3RyaW5ncy5wcmVmaXhBZ28pKTtcbiAgICB9XG4gICAgaWYgKHN1ZmZpeCA9PT0gJ2Zyb20gbm93JyAmJiB0aGlzLmludGwuc3RyaW5ncy5wcmVmaXhGcm9tTm93KSB7XG4gICAgICBkYXRlU3RyaW5nLnB1c2gobm9ybWFsaXplKHRoaXMuaW50bC5zdHJpbmdzLnByZWZpeEZyb21Ob3cpKTtcbiAgICB9XG5cbiAgICAvKiogSGFuZGxlIE1haW4gbnVtYmVyIGFuZCB1bml0ICovXG4gICAgY29uc3QgaXNQbHVyYWwgPSB2YWx1ZSA+IDE7XG4gICAgaWYgKGlzUGx1cmFsKSB7XG4gICAgICBjb25zdCBzdHJpbmdGbjogU3RyaW5nT3JGbiA9IHRoaXMuaW50bC5zdHJpbmdzW3VuaXQgKyAncyddIHx8IHRoaXMuaW50bC5zdHJpbmdzW3VuaXRdIHx8ICclZCAnICsgdW5pdDtcbiAgICAgIGRhdGVTdHJpbmcucHVzaChub3JtYWxpemUoc3RyaW5nRm4pKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3Qgc3RyaW5nRm46IFN0cmluZ09yRm4gPSB0aGlzLmludGwuc3RyaW5nc1t1bml0XSB8fCB0aGlzLmludGwuc3RyaW5nc1t1bml0ICsgJ3MnXSB8fCAnJWQgJyArIHVuaXQ7XG4gICAgICBkYXRlU3RyaW5nLnB1c2gobm9ybWFsaXplKHN0cmluZ0ZuKSk7XG4gICAgfVxuXG4gICAgLyoqIEhhbmRsZSBTdWZmaXhlcyAqL1xuICAgIGlmIChzdWZmaXggPT09ICdhZ28nICYmIHRoaXMuaW50bC5zdHJpbmdzLnN1ZmZpeEFnbykge1xuICAgICAgZGF0ZVN0cmluZy5wdXNoKG5vcm1hbGl6ZSh0aGlzLmludGwuc3RyaW5ncy5zdWZmaXhBZ28pKTtcbiAgICB9XG4gICAgaWYgKHN1ZmZpeCA9PT0gJ2Zyb20gbm93JyAmJiB0aGlzLmludGwuc3RyaW5ncy5zdWZmaXhGcm9tTm93KSB7XG4gICAgICBkYXRlU3RyaW5nLnB1c2gobm9ybWFsaXplKHRoaXMuaW50bC5zdHJpbmdzLnN1ZmZpeEZyb21Ob3cpKTtcbiAgICB9XG5cbiAgICAvKiogam9pbiB0aGUgYXJyYXkgaW50byBhIHN0cmluZyBhbmQgcmV0dXJuIGl0ICovXG4gICAgY29uc3Qgd29yZFNlcGFyYXRvciA9IHR5cGVvZiB0aGlzLmludGwuc3RyaW5ncy53b3JkU2VwYXJhdG9yID09PSAnc3RyaW5nJyA/IHRoaXMuaW50bC5zdHJpbmdzLndvcmRTZXBhcmF0b3IgOiAnICc7XG4gICAgcmV0dXJuIGRhdGVTdHJpbmcuam9pbih3b3JkU2VwYXJhdG9yKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBJZiB0aGUgbnVtYmVycyBhcnJheSBpcyBwcmVzZW50LCBmb3JtYXQgbnVtYmVycyB3aXRoIGl0LFxuICAgKiBvdGhlcndpc2UganVzdCBjYXN0IHRoZSBudW1iZXIgdG8gYSBzdHJpbmcgYW5kIHJldHVybiBpdFxuICAqL1xuICBwcml2YXRlIG5vcm1hbGl6ZU51bWJlcihudW1iZXJzOiBOdW1iZXJBcnJheSwgdmFsdWU6IG51bWJlcikge1xuICAgIHJldHVybiBudW1iZXJzICYmIG51bWJlcnMubGVuZ3RoID09PSAxMFxuICAgICAgPyBTdHJpbmcodmFsdWUpLnNwbGl0KCcnKVxuICAgICAgICAgIC5tYXAoKGRpZ2l0OiBzdHJpbmcpID0+IGRpZ2l0Lm1hdGNoKC9eWzAtOV0kLykgPyBudW1iZXJzW3BhcnNlSW50KGRpZ2l0LCAxMCldIDogZGlnaXQpXG4gICAgICAgICAgLmpvaW4oJycpXG4gICAgICA6IFN0cmluZyh2YWx1ZSk7XG4gIH1cblxuICAvKipcbiAgICogVGFrZSBhIHN0cmluZyBvciBhIGZ1bmN0aW9uIHRoYXQgdGFrZXMgbnVtYmVyIG9mIGRheXMgYW5kIHJldHVybnMgYSBzdHJpbmdcbiAgICogYW5kIHByb3ZpZGUgYSB1bmlmb3JtIEFQSSB0byBjcmVhdGUgc3RyaW5nIHBhcnRzXG4gICovXG4gIHByaXZhdGUgbm9ybWFsaXplRm4odmFsdWU6IG51bWJlciwgbWlsbGlzRGVsdGE6IG51bWJlciwgbnVtYmVycz86IE51bWJlckFycmF5KSB7XG4gICAgcmV0dXJuIChzdHJpbmdPckZuOiBTdHJpbmdPckZuKSA9PlxuICAgICAgdHlwZW9mIHN0cmluZ09yRm4gPT09ICdmdW5jdGlvbidcbiAgICAgID8gc3RyaW5nT3JGbih2YWx1ZSwgbWlsbGlzRGVsdGEpLnJlcGxhY2UoLyVkL2csIHRoaXMubm9ybWFsaXplTnVtYmVyKG51bWJlcnMsIHZhbHVlKSlcbiAgICAgIDogc3RyaW5nT3JGbi5yZXBsYWNlKC8lZC9nLCB0aGlzLm5vcm1hbGl6ZU51bWJlcihudW1iZXJzLCB2YWx1ZSkpO1xuICB9XG59XG4iXX0=